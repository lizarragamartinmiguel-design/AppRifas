<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Administraci√≥n - Rifas Solidarias</title>
  <style>
    /* ESTILOS B√ÅSICOS - Elimina el link a admin.css y usa estos estilos */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    /* Login Section */
    .login-section {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .login-form {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
    }
    
    .login-header h2 {
      text-align: center;
      margin-bottom: 10px;
      color: #333;
    }
    
    .login-subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn-login {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn-login:hover {
      transform: translateY(-2px);
    }
    
    .login-help {
      text-align: center;
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }
    
    /* Dashboard */
    .dashboard {
      background: white;
      min-height: 100vh;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .dashboard-header h1 {
      font-size: 24px;
    }
    
    .btn-logout {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .nav-tabs {
      background: #f8f9fa;
      display: flex;
      list-style: none;
      border-bottom: 2px solid #dee2e6;
    }
    
    .nav-tabs li {
      padding: 15px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    
    .nav-tabs li.active {
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: 600;
    }
    
    .nav-tabs li:hover {
      background: #e9ecef;
    }
    
    .dashboard-content {
      padding: 20px;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-number {
      display: block;
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    
    /* Rifa Cards */
    .rifa-admin-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
    }
    
    .rifa-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .rifa-header h3 {
      color: #333;
    }
    
    .rifa-actions {
      display: flex;
      gap: 10px;
    }
    
    .rifa-actions button {
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-sorteo { background: #28a745; color: white; }
    .btn-edit { background: #ffc107; color: black; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-vender { background: #17a2b8; color: white; }
    
    .rifa-desc {
      color: #666;
      margin-bottom: 15px;
    }
    
    .rifa-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    
    .stat {
      text-align: center;
      padding: 10px;
      background: white;
      border-radius: 5px;
    }
    
    .stat-value {
      display: block;
      font-size: 16px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
    }
    
    /* Form Styles */
    .form-container {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    
    .form-group-full {
      width: 100%;
    }
    
    .config-section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .config-section h4 {
      margin-bottom: 15px;
      color: #333;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    
    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1000;
      font-weight: 600;
      max-width: 300px;
    }
    
    .notification-success { background: #4CAF50; }
    .notification-error { background: #f44336; }
    .notification-info { background: #2196F3; }
    
    /* Reservas */
    .reserva-card {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .reserva-actions {
      display: flex;
      gap: 10px;
    }
    
    .btn-confirmar { background: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-cancelar { background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
  </style>
  <link rel="icon" href="data:,">
</head>
<body>

  <!-- LOGIN -->
  <div class="login-section" id="loginSection">
    <div class="login-form">
      <div class="login-header">
        <h2>üîê Acceso Administrativo</h2>
        <p class="login-subtitle">Sistema de Gesti√≥n de Rifas</p>
      </div>
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Usuario:</label>
          <input type="text" id="username" required placeholder="admin" value="admin">
        </div>
        <div class="form-group">
          <label for="password">Contrase√±a:</label>
          <input type="password" id="password" required placeholder="pagos10" value="pagos10">
        </div>
        <button type="submit" class="btn-login">Ingresar al Panel</button>
        <div class="login-help">
          <p>¬øProblemas? Contacta al administrador.</p>
        </div>
      </form>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard" id="dashboard" style="display: none;">
    <div class="dashboard-header">
      <h1>üéØ Panel de Administraci√≥n - Rifas Solidarias</h1>
      <button class="btn-logout" id="btnLogout">üö™ Cerrar Sesi√≥n</button>
    </div>

    <nav class="dashboard-nav">
      <ul class="nav-tabs">
        <li class="active" data-tab="dashboard">üìä Dashboard</li>
        <li data-tab="rifas">üé´ Gestionar Rifas</li>
        <li data-tab="sorteos">üé∞ Sorteos</li>
        <li data-tab="config">‚öôÔ∏è Configuraci√≥n</li>
      </ul>
    </nav>

    <div class="dashboard-content">
      <!-- Dashboard -->
      <div id="tab-dashboard" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><span class="stat-number" id="quickSold">0</span><span class="stat-label">Boletos Vendidos</span></div>
          <div class="stat-card"><span class="stat-number" id="quickRaised">$0</span><span class="stat-label">Total Recaudado</span></div>
          <div class="stat-card"><span class="stat-number" id="quickAvailable">0</span><span class="stat-label">Rifas Activas</span></div>
          <div class="stat-card"><span class="stat-number" id="quickParticipants">0</span><span class="stat-label">Participantes</span></div>
        </div>
        <h3>Rifas Activas</h3>
        <div id="rifasListDashboard" class="rifas-list"></div>
      </div>

      <!-- Gestionar Rifas -->
      <div id="tab-rifas" class="tab-content">
        <div class="form-container">
          <h3>‚ûï Crear Nueva Rifa</h3>
          <form id="rifaConfigForm">
            <div class="form-row">
              <div class="form-group"><label for="titulo">T√≠tulo de la Rifa:</label><input type="text" id="titulo" required placeholder="Ej: Rifa Solidaria Navidad 2024"></div>
              <div class="form-group"><label for="precioNumero">Precio por N√∫mero:</label><input type="number" id="precioNumero" required min="1" step="0.01" placeholder="20.00"></div>
            </div>
            <div class="form-group form-group-full"><label for="descripcion">Descripci√≥n:</label><textarea id="descripcion" required placeholder="Descripci√≥n de la rifa y premios"></textarea></div>
            <div class="form-row">
              <div class="form-group"><label for="totalNumeros">Total de N√∫meros:</label><input type="number" id="totalNumeros" required min="1" placeholder="500"></div>
              <div class="form-group"><label for="metaRecaudacion">Meta de Recaudaci√≥n:</label><input type="number" id="metaRecaudacion" required min="1" step="0.01" placeholder="10000.00"></div>
            </div>
            <div class="form-row">
              <div class="form-group"><label for="fechaSorteo">Fecha del Sorteo:</label><input type="datetime-local" id="fechaSorteo" required></div>
              <div class="form-group"><button type="submit" class="btn-login">üíæ Guardar Rifa</button></div>
            </div>
          </form>
        </div>
        <h3>üéØ Rifas Existentes</h3>
        <div id="rifasList" class="rifas-list"></div>
      </div>

      <!-- Sorteos -->
      <div id="tab-sorteos" class="tab-content">
        <div class="form-container">
          <h3>üé∞ Realizar Sorteo</h3>
          <div class="form-group"><label for="selectRifaSorteo">Seleccionar Rifa:</label>
            <select id="selectRifaSorteo"><option value="">-- Selecciona una rifa --</option></select>
          </div>
          <div class="form-group"><button id="btnRealizarSorteo" class="btn-login">üéØ Realizar Sorteo</button></div>
        </div>
        <h3>üìã Historial de Sorteos</h3>
        <div id="historialSorteos" class="rifas-list"></div>
      </div>

      <!-- Configuraci√≥n -->
      <div id="tab-config" class="tab-content">
        <div class="form-container">
          <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
          <div class="config-section">
            <h4>üì± WhatsApp</h4>
            <div class="form-group"><label for="whatsappNumber">N√∫mero de WhatsApp:</label><input type="text" id="whatsappNumber" placeholder="+5491112345678"></div>
            <div class="form-group"><label for="whatsappMessage">Mensaje de WhatsApp:</label><textarea id="whatsappMessage" placeholder="Hola! Quiero comprar el n√∫mero {numero} de la rifa {rifa}. Mi nombre es {nombre}"></textarea><small>Variables: {numero}, {rifa}, {nombre}, {telefono}, {precio}</small></div>
          </div>
          <div class="config-section">
            <h4>üé∞ Sorteos</h4>
            <div class="form-group"><label for="sorteoGrabacion">Requerir grabaci√≥n de sorteo:</label><select id="sorteoGrabacion"><option value="si">S√≠</option><option value="no">No</option></select></div>
            <div class="form-group"><label for="mensajeGanador">Mensaje para el ganador:</label><textarea id="mensajeGanador" placeholder="¬°Felicidades {nombre}! Ganaste la rifa {rifa} con el n√∫mero {numero}"></textarea></div>
          </div>
          <button id="btnGuardarConfig" class="btn-login">üíæ Guardar Configuraci√≥n</button>
          <br><br>
          <button id="btnSync" class="btn-login">üîÑ Sincronizar contadores</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Sorteo -->
  <div class="modal" id="modalSorteo">
    <div class="modal-content">
      <div class="modal-header"><h3>üéâ Resultado del Sorteo</h3><button class="close-modal">&times;</button></div>
      <div id="resultadoSorteoContent"></div>
    </div>
  </div>

  <!-- Parse SDK -->
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>

  <script>
    /* ---------- CONFIG BACK4APP CORREGIDA ---------- */
    Parse.initialize("NNxoqUEYiTkyO1MxAmxF6lGPeHhmqXUxG8bZGyPr", "hO0qRKANPmDLu3spkcDLLTBTeYIQSfCNJg8T0dUH");
    Parse.serverURL = "https://parseapi.back4app.com/"; // SIN ESPACIOS

    /* ---------- CLASES AUXILIARES ---------- */
    class SistemaSorteo {
      async realizarSorteo(rifaId) {
        const Numeros = Parse.Object.extend("Numeros");
        const query = new Parse.Query(Numeros);
        query.equalTo("rifaId", rifaId);
        query.equalTo("vendido", true);
        const numerosVendidos = await query.find();
        if (numerosVendidos.length === 0) throw new Error("No hay n√∫meros vendidos para realizar el sorteo");
        const ganadorIndex = Math.floor(Math.random() * numerosVendidos.length);
        const numeroGanador = numerosVendidos[ganadorIndex];
        const Sorteo = Parse.Object.extend("Sorteo");
        const sorteo = new Sorteo();
        await sorteo.save({
          rifaId: rifaId,
          numeroGanador: numeroGanador.get('numero'),
          ganador: numeroGanador.get('comprador'),
          telefono: numeroGanador.get('telefono'),
          email: numeroGanador.get('email'),
          fechaSorteo: new Date(),
          totalParticipantes: numerosVendidos.length,
          estado: 'completado'
        });
        const Rifa = Parse.Object.extend("Rifa");
        const rifaQuery = new Parse.Query(Rifa);
        const rifa = await rifaQuery.get(rifaId);
        rifa.set('estado', 'sorteada');
        await rifa.save();
        return {
          ganador: numeroGanador.get('comprador'),
          numero: numeroGanador.get('numero'),
          telefono: numeroGanador.get('telefono'),
          email: numeroGanador.get('email'),
          fecha: new Date(),
          totalParticipantes: numerosVendidos.length
        };
      }
      async obtenerHistorialSorteos() {
        const Sorteo = Parse.Object.extend("Sorteo");
        const query = new Parse.Query(Sorteo);
        query.include("rifaId");
        query.descending("fechaSorteo");
        const sorteos = await query.find();
        return sorteos.map(sorteo => ({
          id: sorteo.id,
          rifa: sorteo.get('rifaId') ? sorteo.get('rifaId').get('titulo') : 'Rifa no encontrada',
          ganador: sorteo.get('ganador'),
          numero: sorteo.get('numeroGanador'),
          telefono: sorteo.get('telefono'),
          fecha: sorteo.get('fechaSorteo'),
          participantes: sorteo.get('totalParticipantes')
        }));
      }
    }

    /* ---------- ADMIN SYSTEM CORREGIDO ---------- */
    class AdminSystem {
      constructor() {
        this.rifas = [];
        this.sorteos = [];
        this.sistemaSorteo = new SistemaSorteo();
        this.init();
      }
      async init() {
        console.log('üöÄ Iniciando sistema admin...');
        this.setupEventListeners();
        await this.checkAuth();
        await this.cargarConfiguracion();
        console.log('‚úÖ Sistema admin inicializado');
      }
      setupEventListeners() {
        document.getElementById('loginForm').addEventListener('submit', e => { e.preventDefault(); this.login(); });
        document.getElementById('btnLogout').addEventListener('click', () => this.logout());
        document.querySelectorAll('.nav-tabs li').forEach(btn => btn.addEventListener('click', e => {
          const tab = e.target.getAttribute('data-tab');
          this.switchTab(tab);
        }));
        document.getElementById('rifaConfigForm').addEventListener('submit', e => { e.preventDefault(); this.guardarRifa(); });
        document.getElementById('btnRealizarSorteo').addEventListener('click', () => this.realizarSorteo());
        document.getElementById('btnGuardarConfig').addEventListener('click', () => this.guardarConfiguracion());
        document.querySelector('.close-modal').addEventListener('click', () => this.cerrarModalSorteo());
        document.getElementById('btnSync').addEventListener('click', () => this.sincronizarVendidos());
      }
      async login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        try {
          await Parse.User.logIn(username, password);
          this.showSection('dashboard');
          this.showNotification('‚úÖ Inicio de sesi√≥n exitoso', 'success');
          await this.cargarRifas();
          await this.cargarSorteos();
        } catch (error) {
          this.showNotification('‚ùå Usuario o contrase√±a incorrectos', 'error');
        }
      }
      async logout() {
        try { 
          await Parse.User.logOut(); 
        } catch (e) { 
          console.log('Error en logout:', e);
        }
        this.showSection('login');
        this.showNotification('üëã Sesi√≥n cerrada', 'info');
      }
      async checkAuth() {
        const currentUser = Parse.User.current();
        if (currentUser) {
          console.log('‚úÖ Usuario ya autenticado:', currentUser.get("username"));
          this.showSection('dashboard');
          await this.cargarRifas();
          await this.cargarSorteos();
        } else {
          console.log('üîí No hay usuario autenticado');
          this.showSection('login');
        }
      }
      showSection(sectionName) {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'none';
        if (sectionName === 'login') {
          document.getElementById('loginSection').style.display = 'flex';
        } else {
          document.getElementById('dashboard').style.display = 'block';
          this.loadDashboard();
        }
      }
      async cargarRifas() {
        try {
          const Rifa = Parse.Object.extend("Rifa");
          const query = new Parse.Query(Rifa);
          query.ascending('createdAt');
          const results = await query.find();
          this.rifas = results.map(rifa => ({
            id: rifa.id,
            titulo: rifa.get('titulo') || 'Sin t√≠tulo',
            descripcion: rifa.get('descripcion') || '',
            precioNumero: rifa.get('precioNumero') || 0,
            totalNumeros: rifa.get('totalNumeros') || 0,
            numerosVendidos: rifa.get('numerosVendidos') || 0,
            fechaSorteo: rifa.get('fechaSorteo'),
            metaRecaudacion: rifa.get('metaRecaudacion') || 0,
            estado: rifa.get('estado') || 'activa'
          }));
          this.mostrarRifas();
          this.actualizarSelectSorteo();
          this.updateQuickStats();
        } catch (error) {
          console.error('Error cargando rifas:', error);
          this.showNotification('‚ùå Error al cargar rifas', 'error');
        }
      }
      mostrarRifas() {
        const container = document.getElementById('rifasList');
        const dashboardContainer = document.getElementById('rifasListDashboard');
        
        const html = this.rifas.map(rifa => `
          <div class="rifa-admin-card">
            <div class="rifa-header">
              <h3>${rifa.titulo}</h3>
              <div class="rifa-actions">
                <button class="btn-sorteo" ${rifa.estado === 'sorteada' || rifa.numerosVendidos === 0 ? 'disabled' : ''} onclick="adminSystem.prepararSorteo('${rifa.id}')">üé∞ Sorteo</button>
                <button class="btn-edit" onclick="adminSystem.editarRifa('${rifa.id}')">‚úèÔ∏è Editar</button>
                <button class="btn-delete" onclick="adminSystem.eliminarRifa('${rifa.id}')">üóëÔ∏è Eliminar</button>
                <button class="btn-vender" onclick="adminSystem.marcarComoVendido('${rifa.id}')">üí∞ Marcar N¬∫ Vendido</button>
              </div>
            </div>
            <p class="rifa-desc">${rifa.descripcion}</p>
            <div class="rifa-stats">
              <div class="stat"><span class="stat-value">${rifa.numerosVendidos}</span><span class="stat-label">Vendidos</span></div>
              <div class="stat"><span class="stat-value">${rifa.totalNumeros - rifa.numerosVendidos}</span><span class="stat-label">Disponibles</span></div>
              <div class="stat"><span class="stat-value">$${(rifa.numerosVendidos * rifa.precioNumero).toFixed(2)}</span><span class="stat-label">Recaudado</span></div>
              <div class="stat"><span class="stat-value">${rifa.estado}</span><span class="stat-label">Estado</span></div>
            </div>
          </div>
        `).join('');
        
        if (container) container.innerHTML = html;
        if (dashboardContainer) dashboardContainer.innerHTML = html;
      }
      // FUNCI√ìN EDITAR RIFA FALTANTE - AGREGADA
      editarRifa(rifaId) {
        this.showNotification('‚úèÔ∏è Funci√≥n de edici√≥n en desarrollo', 'info');
      }
      async guardarRifa() {
        const titulo = document.getElementById('titulo').value.trim();
        const descripcion = document.getElementById('descripcion').value.trim();
        const precioNumero = parseFloat(document.getElementById('precioNumero').value) || 0;
        const totalNumeros = parseInt(document.getElementById('totalNumeros').value) || 0;
        const rawFecha = document.getElementById('fechaSorteo').value;
        const metaRecaudacion = parseFloat(document.getElementById('metaRecaudacion').value) || 0;

        if (!titulo || !descripcion || !rawFecha) {
          this.showNotification('‚ùå T√≠tulo, descripci√≥n y fecha son obligatorios', 'error');
          return;
        }
        if (precioNumero <= 0 || totalNumeros <= 0 || metaRecaudacion <= 0) {
          this.showNotification('‚ùå Precio, cantidad de n√∫meros y meta deben ser mayores a 0', 'error');
          return;
        }

        const rifaData = {
          titulo,
          descripcion,
          precioNumero,
          totalNumeros,
          fechaSorteo: new Date(rawFecha).toISOString(),
          metaRecaudacion,
          estado: 'activa',
          numerosVendidos: 0
        };

        try {
          const Rifa = Parse.Object.extend("Rifa");
          const rifa = new Rifa();
          await rifa.save(rifaData);
          await this.crearNumerosParaRifa(rifa.id, totalNumeros);
          this.showNotification('‚úÖ Rifa y n√∫meros creados correctamente', 'success');
          document.getElementById('rifaConfigForm').reset();
          await this.cargarRifas();
        } catch (err) {
          console.error('‚ùå Error guardando rifa:', err);
          this.showNotification('‚ùå Error al crear la rifa: ' + err.message, 'error');
        }
      }
      async crearNumerosParaRifa(rifaId, totalNumeros) {
        try {
          const Numeros = Parse.Object.extend("Numeros");
          const numeros = [];
          for (let i = 1; i <= totalNumeros; i++) {
            const numero = new Numeros();
            numero.set('rifaId', rifaId);
            numero.set('numero', i);
            numero.set('vendido', false);
            numero.set('comprador', '');
            numero.set('telefono', '');
            numero.set('email', '');
            numeros.push(numero);
          }
          const batchSize = 50;
          for (let i = 0; i < numeros.length; i += batchSize) {
            await Parse.Object.saveAll(numeros.slice(i, i + batchSize));
          }
        } catch (error) {
          console.error('Error creando n√∫meros:', error);
          throw error;
        }
      }
      async eliminarRifa(rifaId) {
        if (!confirm('¬øEst√°s seguro de eliminar esta rifa y todos sus n√∫meros?')) return;
        try {
          const Numeros = Parse.Object.extend("Numeros");
          const queryNumeros = new Parse.Query(Numeros);
          queryNumeros.equalTo("rifaId", rifaId);
          const numeros = await queryNumeros.find();
          if (numeros.length > 0) await Parse.Object.destroyAll(numeros);
          const Rifa = Parse.Object.extend("Rifa");
          const queryRifa = new Parse.Query(Rifa);
          const rifa = await queryRifa.get(rifaId);
          await rifa.destroy();
          this.showNotification('‚úÖ Rifa y n√∫meros eliminados', 'success');
          await this.cargarRifas();
        } catch (error) {
          this.showNotification('‚ùå Error al eliminar la rifa', 'error');
        }
      }
      actualizarSelectSorteo() {
        const select = document.getElementById('selectRifaSorteo');
        select.innerHTML = '<option value="">-- Selecciona una rifa --</option>';
        this.rifas
          .filter(r => r.estado === 'activa' && r.numerosVendidos > 0)
          .forEach(r => {
            const option = document.createElement('option');
            option.value = r.id;
            option.textContent = `${r.titulo} (${r.numerosVendidos} vendidos)`;
            select.appendChild(option);
          });
      }
      prepararSorteo(rifaId) {
        document.getElementById('selectRifaSorteo').value = rifaId;
        this.switchTab('sorteos');
      }
      async realizarSorteo() {
        const rifaId = document.getElementById('selectRifaSorteo').value;
        if (!rifaId) return this.showNotification('‚ùå Selecciona una rifa primero', 'error');
        const rifa = this.rifas.find(r => r.id === rifaId);
        if (!rifa) return this.showNotification('‚ùå Rifa no encontrada', 'error');
        if (rifa.numerosVendidos === 0) return this.showNotification('‚ùå No hay n√∫meros vendidos para sortear', 'error');
        if (!confirm(`¬øEst√°s seguro de realizar el sorteo para "${rifa.titulo}"? Esta acci√≥n no se puede deshacer.`)) return;
        try {
          this.showNotification('üé∞ Realizando sorteo...', 'info');
          const resultado = await this.sistemaSorteo.realizarSorteo(rifaId);
          this.mostrarResultadoSorteo(resultado, rifa);
          await this.cargarRifas();
          await this.cargarSorteos();
        } catch (error) {
          this.showNotification('‚ùå Error en el sorteo: ' + error.message, 'error');
        }
      }
      mostrarResultadoSorteo(resultado, rifa) {
        const modal = document.getElementById('modalSorteo');
        const content = document.getElementById('resultadoSorteoContent');
        content.innerHTML = `
          <div class="resultado-sorteo">
            <h4>üéâ ¬°Tenemos un ganador!</h4>
            <div class="ganador-info"><strong>${resultado.ganador}</strong></div>
            <p>N√∫mero ganador: <strong>${resultado.numero}</strong></p>
            <p>Tel√©fono: <strong>${resultado.telefono}</strong></p>
            <p>Email: <strong>${resultado.email || 'No proporcionado'}</strong></p>
            <p>Rifa: <strong>${rifa.titulo}</strong></p>
            <p>Total participantes: <strong>${resultado.totalParticipantes}</strong></p>
            <p>Fecha: <strong>${new Date(resultado.fecha).toLocaleString()}</strong></p>
          </div>
          <div style="text-align: center; margin-top: 20px;"><button class="btn-login" onclick="adminSystem.cerrarModalSorteo()">Cerrar</button></div>
        `;
        modal.style.display = 'flex';
      }
      cerrarModalSorteo() {
        document.getElementById('modalSorteo').style.display = 'none';
      }
      async cargarSorteos() {
        this.sorteos = await this.sistemaSorteo.obtenerHistorialSorteos();
        this.mostrarHistorialSorteos();
      }
      mostrarHistorialSorteos() {
        const container = document.getElementById('historialSorteos');
        container.innerHTML = this.sorteos.length === 0
          ? '<p>No hay sorteos realizados.</p>'
          : this.sorteos.map(sorteo => `
            <div class="rifa-admin-card">
              <div class="rifa-header"><h3>${sorteo.rifa}</h3><span class="stat-value">#${sorteo.numero}</span></div>
              <div class="rifa-stats">
                <div class="stat"><span class="stat-value">${sorteo.ganador}</span><span class="stat-label">Ganador</span></div>
                <div class="stat"><span class="stat-value">${sorteo.telefono}</span><span class="stat-label">Tel√©fono</span></div>
                <div class="stat"><span class="stat-value">${sorteo.participantes}</span><span class="stat-label">Participantes</span></div>
                <div class="stat"><span class="stat-value">${new Date(sorteo.fecha).toLocaleDateString()}</span><span class="stat-label">Fecha</span></div>
              </div>
            </div>
          `).join('');
      }
      async cargarConfiguracion() {
        try {
          const Config = Parse.Object.extend("Config");
          const query = new Parse.Query(Config);
          const config = await query.first();
          if (config) {
            document.getElementById('whatsappNumber').value = config.get('whatsappNumber') || '';
            document.getElementById('whatsappMessage').value = config.get('whatsappMessage') || '';
            document.getElementById('sorteoGrabacion').value = config.get('sorteoGrabacion') || 'si';
            document.getElementById('mensajeGanador').value = config.get('mensajeGanador') || '';
          }
        } catch (error) {
          console.log('No hay configuraci√≥n guardada o error:', error.message);
        }
      }
      async guardarConfiguracion() {
        try {
          const Config = Parse.Object.extend("Config");
          const query = new Parse.Query(Config);
          let config = await query.first();
          if (!config) config = new Config();
          await config.save({
            whatsappNumber: document.getElementById('whatsappNumber').value,
            whatsappMessage: document.getElementById('whatsappMessage').value,
            sorteoGrabacion: document.getElementById('sorteoGrabacion').value,
            mensajeGanador: document.getElementById('mensajeGanador').value
          });
          this.showNotification('‚úÖ Configuraci√≥n guardada', 'success');
        } catch (error) {
          this.showNotification('‚ùå Error guardando configuraci√≥n', 'error');
        }
      }
      switchTab(tabName) {
        document.querySelectorAll('.nav-tabs li').forEach(li => li.classList.remove('active'));
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
      }
      loadDashboard() {
        this.updateQuickStats();
        this.switchTab('dashboard');
      }
      updateQuickStats() {
        const totalVendidos = this.rifas.reduce((sum, rifa) => sum + rifa.numerosVendidos, 0);
        const totalRecaudado = this.rifas.reduce((sum, rifa) => sum + (rifa.numerosVendidos * rifa.precioNumero), 0);
        document.getElementById('quickSold').textContent = totalVendidos;
        document.getElementById('quickRaised').textContent = `$${totalRecaudado.toFixed(2)}`;
        document.getElementById('quickAvailable').textContent = this.rifas.filter(r => r.estado === 'activa').length;
        document.getElementById('quickParticipants').textContent = this.rifas.length * 10;
      }
      showNotification(message, type) {
        // Eliminar notificaciones existentes
        document.querySelectorAll('.notification').forEach(notif => notif.remove());
        
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 5000);
      }
      async sincronizarVendidos() {
        try {
          for (const rifa of this.rifas) {
            const Numeros = Parse.Object.extend("Numeros");
            const vendidos = await new Parse.Query(Numeros)
              .equalTo("rifaId", rifa.id)
              .equalTo("vendido", true)
              .count();

            if (vendidos !== rifa.numerosVendidos) {
              const Rifa = Parse.Object.extend("Rifa");
              const obj = await new Parse.Query(Rifa).get(rifa.id);
              obj.set("numerosVendidos", vendidos);
              await obj.save();
              rifa.numerosVendidos = vendidos;
            }
          }
          this.mostrarRifas();
          this.updateQuickStats();
          this.showNotification("‚úÖ Contadores sincronizados", "success");
        } catch (e) {
          this.showNotification("‚ùå Error: " + e.message, "error");
        }
      }
      async marcarComoVendido(rifaId) {
        const numero = prompt("¬øQu√© n√∫mero quer√©s marcar como vendido? (1-N)");
        if (!numero || isNaN(numero)) return;
        try {
          const Numeros = Parse.Object.extend("Numeros");
          const query = new Parse.Query(Numeros);
          query.equalTo("rifaId", rifaId);
          query.equalTo("numero", parseInt(numero));
          const numeroObj = await query.first();
          if (!numeroObj) return this.showNotification("‚ùå N√∫mero no encontrado", "error");
          if (numeroObj.get('vendido')) return this.showNotification("‚ùå Ese n√∫mero ya est√° vendido", "info");
          numeroObj.set('vendido', true);
          numeroObj.set('comprador', 'Admin Manual');
          numeroObj.set('telefono', '+5490000000000');
          numeroObj.set('email', 'admin@manual.com');
          await numeroObj.save();
          const Rifa = Parse.Object.extend("Rifa");
          const rifaObj = await new Parse.Query(Rifa).get(rifaId);
          rifaObj.increment('numerosVendidos', 1);
          await rifaObj.save();
          this.showNotification("‚úÖ N√∫mero marcado como vendido", "success");
          await this.cargarRifas();
        } catch (err) {
          this.showNotification("‚ùå Error: " + err.message, "error");
        }
      }
    }

    /* ---------- INICIALIZAR ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      window.adminSystem = new AdminSystem();
    });
  </script>
</body>
</html>